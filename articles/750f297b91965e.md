---
title: "Railsã®validatesãƒ¡ã‚½ãƒƒãƒ‰ã«ã¤ã„ã¦èª¿ã¹ã¦ã¿ãŸ"
emoji: "ğŸ”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Ruby", "Rails"]
published: false
---

railsã§ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«æ›¸ãã“ã¨ã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œãˆã‚‹([ã‚³ãƒ¼ãƒ‰å‚ç…§å…ƒ](https://railsguides.jp/active_record_validations.html#%E3%83%90%E3%83%AA%E3%83%87%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E6%A6%82%E8%A6%81
))ã€‚
```ruby
class Person < ApplicationRecord
  validates :name, presence: true
end
```

ã“ã®`validates`ãƒ¡ã‚½ãƒƒãƒ‰ãŒã©ã®ã‚ˆã†ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹æ°—ã«ãªã£ãŸã®ã§èª¿ã¹ã¦ã¿ãŸã€‚

### ã©ã“ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã®ã‹
#### ApplicationRecord
`ActiveRecord::Base`ã‚’ç¶™æ‰¿ã—ã¦ã„ã‚‹ã‚¯ãƒ©ã‚¹ã§ã‚ã‚Šã€`rails new`ã§è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ã€‚

https://github.com/rails/rails/blob/main/railties/lib/rails/generators/rails/app/templates/app/models/application_record.rb.tt

#### ActiveRecord::Base

ActiveRecord::Validationsã‚’includeã—ã¦ã„ã‚‹ã€‚
https://github.com/rails/rails/blob/66099147482ea431febf20936cec903f197d24be/activerecord/lib/active_record/base.rb#L307-L311


#### ActiveRecord::Validations

ActiveModel::Validationsã‚’includeã—ã¦ã„ã‚‹ã€‚
https://github.com/rails/rails/blob/66099147482ea431febf20936cec903f197d24be/activerecord/lib/active_record/validations.rb#L40-L42


#### ActiveModel::Validations

validatesãƒ¡ã‚½ãƒƒãƒ‰ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã‚‹ã€‚
https://github.com/rails/rails/blob/66099147482ea431febf20936cec903f197d24be/activemodel/lib/active_model/validations.rb#L471

#### ActiveModel::Validations::ClassMethods#validates

`validates`ãƒ¡ã‚½ãƒƒãƒ‰ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã€‚
https://github.com/rails/rails/blob/66099147482ea431febf20936cec903f197d24be/activemodel/lib/active_model/validations/validates.rb#L106-L128

### ActiveModel::Validations::ClassMethods#validatesã®ä¸­èº«ã‚’èª­ã‚€

ä¸‹è¨˜ã®å ´åˆã‚’è€ƒãˆã‚‹([ã‚³ãƒ¼ãƒ‰å‚ç…§å…ƒ](https://railsguides.jp/active_record_validations.html#if%E3%82%84-unless%E3%81%A7%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E3%82%92%E4%BD%BF%E3%81%86))ã€‚
```ruby
class Order < ApplicationRecord
  validates :card_number, presence: true, if: :paid_with_card?

  def paid_with_card?
    payment_type == "card"
  end
end
```
#### 1. validatesãƒ¡ã‚½ãƒƒãƒ‰ã®å¼•æ•°ã‚’ç¢ºèªã™ã‚‹
https://github.com/rails/rails/blob/66099147482ea431febf20936cec903f197d24be/activemodel/lib/active_model/validations/validates.rb#L106-L108

railsã¯ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ã‚’ä»˜ã‘ã‚‹ã“ã¨ã§å¼•æ•°ã‚’é…åˆ—ã«æŒ‡å®šã§ãã‚‹ã®ã§ã€`attributes = [:name, {:presence=>true, :if=>:paid_with_card?}]`ã¨ãªã‚‹ã€‚
`extract_options!`ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹(ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ç†ç”±ã¯[Railsã‚¬ã‚¤ãƒ‰](https://railsguides.jp/active_support_core_extensions.html#%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%B1%95%E9%96%8B)ãŒå‚è€ƒã«ãªã‚‹)ã€‚

https://github.com/rails/rails/blob/9d74450a0f8ae658207f1f662367381c248eb7a8/activesupport/lib/active_support/core_ext/array/extract_options.rb#L24-L30

ã“ã‚Œã«ã‚ˆã‚Šã€
```ruby
defaults = {:presence=>true, :if=>:paid_with_card?}
```

ã¾ãŸã€
https://github.com/rails/rails/blob/66099147482ea431febf20936cec903f197d24be/activemodel/lib/active_model/validations/validates.rb#L157-L159
https://github.com/rails/rails/blob/9d74450a0f8ae658207f1f662367381c248eb7a8/activesupport/lib/active_support/core_ext/hash/slice.rb#L10-L17
ã«ã‚ˆã‚Šã€
```ruby
defaults = {:if=>:paid_with_card?}
validations = {:presence=>true}
```

#### 2. validationã®ã‚¯ãƒ©ã‚¹ã‚’å–å¾—ã™ã‚‹

https://github.com/rails/rails/blob/66099147482ea431febf20936cec903f197d24be/activemodel/lib/active_model/validations/validates.rb#L113-L127
`key = "PresenceValidator"`ã¨ãªã‚Šã€`const_get`ãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚ˆã‚Šã€
`validator = ActiveModel::Validations::PresenceValidator`ã¨ãªã‚‹(ã‚¯ãƒ©ã‚¹ãŒå®šç¾©ã•ã‚Œã‚‹ã¨ãã«ã€`PresenceValidator`ã¨ã„ã†åå‰ã§ã€`ActiveModel::Validations::PresenceValidator`ã‚’å€¤ã¨ã—ã¦è¿½åŠ ã—ã¦ã„ã‚‹ãŸã‚)ã€‚

ä»Šå›ã¯`options`ãŒ`true`ã®ãŸã‚ã€
https://github.com/rails/rails/blob/66099147482ea431febf20936cec903f197d24be/activemodel/lib/active_model/validations/validates.rb#L161-L172
ã«ã‚ˆã‚Šã€
```ruby
validates_with(ActiveModel::Validations::PresenceValidator, {:if=>:paid_with_card?, :attributes=>[:name]})
```

### ActiveModel::Validations::ClassMethods#validates_withã®ä¸­èº«ã‚’èª­ã‚€

#### 1. validates_withãƒ¡ã‚½ãƒƒãƒ‰ã®å¼•æ•°ã‚’ç¢ºèªã™ã‚‹
https://github.com/rails/rails/blob/9d74450a0f8ae658207f1f662367381c248eb7a8/activemodel/lib/active_model/validations/with.rb#L88-L90

`args = [ActiveModel::Validations::PresenceValidator, {:if=>:paid_with_card?, :attributes=>[:name]}]`ã¨ãªã‚Šã€`block`ã«ã¯`nil`ãŒå…¥ã‚‹ã€‚
`self = Order`ãªã®ã§ã€
```ruby
options = {:if=>:paid_with_card?, :attributes=>[:name], :class=>Order}
args = [ActiveModel::Validations::PresenceValidator]
```

#### 2. validatorã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã™ã‚‹
https://github.com/rails/rails/blob/9d74450a0f8ae658207f1f662367381c248eb7a8/activemodel/lib/active_model/validations/with.rb#L92-L93
ä»Šå›ã¯`ActiveModel::Validations::PresenceValidator`ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã™ã‚‹ã€‚

#### 3. validatorã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½¿ã£ã¦validateãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™

https://github.com/rails/rails/blob/9d74450a0f8ae658207f1f662367381c248eb7a8/activemodel/lib/active_model/validations/with.rb#L95-L105

`ActiveModel::Validations::PresenceValidator`ã¯`ActiveModel::EachValidator`ã‚’ç¶™æ‰¿ã—ã¦ã„ã‚‹ã®ã§ã€`validator.attributes = [:name]`ã¨ãªã‚‹ã€‚
https://github.com/rails/rails/blob/9d74450a0f8ae658207f1f662367381c248eb7a8/activemodel/lib/active_model/validator.rb#L134-L145

`_validators`ã¯ã‚¯ãƒ©ã‚¹å±æ€§ã¨ã—ã¦å®šç¾©ã•ã‚Œã¦ãŠã‚Šã€`_validators[:name] = [ActiveModel::Validations::PresenceValidator]`ã¨ãªã‚‹ã€‚
https://github.com/rails/rails/blob/9d74450a0f8ae658207f1f662367381c248eb7a8/activemodel/lib/active_model/validations.rb#L71

`validate`ãƒ¡ã‚½ãƒƒãƒ‰ã¯æ¬¡ã§å‘¼ã³å‡ºã•ã‚Œã‚‹ã€‚
```ruby
validate(ActiveModel::Validations::PresenceValidator.new, {:if=>:paid_with_card?, :attributes=>[:name], :class=>Order})
```

### ActiveModel::Validations::ClassMethods#validateã®ä¸­èº«ã‚’èª­ã‚€

#### 1. validateãƒ¡ã‚½ãƒƒãƒ‰ã®å¼•æ•°ã‚’ç¢ºèªã™ã‚‹

https://github.com/rails/rails/blob/9d74450a0f8ae658207f1f662367381c248eb7a8/activemodel/lib/active_model/validations.rb#L171-L172

`args = [ActiveModel::Validations::PresenceValidator.new, {:if=>:paid_with_card?, :attributes=>[:name], :class=>Order}]`ã¨ãªã‚Šã€`block`ã«ã¯`nil`ãŒå…¥ã‚‹ã€‚
`extract_options!`ã«ã‚ˆã‚Šã€
```ruby
options = {:if=>:paid_with_card?, :attributes=>[:name], :class=>Order}
args = [ActiveModel::Validations::PresenceValidator.new]
```

#### 2. set_callbackãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™

https://github.com/rails/rails/blob/9d74450a0f8ae658207f1f662367381c248eb7a8/activemodel/lib/active_model/validations.rb#L174-L180
`args.all?(Symbol)`ã¯`false`ã¨ãªã‚‹ã®ã§ã€ã“ã“ã¯å‘¼ã³å‡ºã•ã‚Œãªã„ã€‚

https://github.com/rails/rails/blob/9d74450a0f8ae658207f1f662367381c248eb7a8/activemodel/lib/active_model/validations.rb#L182-L184
`options.key?(:on)`ã¯`false`ã¨ãªã‚‹ã®ã§ã€ã“ã“ã¯å‘¼ã³å‡ºã•ã‚Œãªã„ã€‚

https://github.com/rails/rails/blob/9d74450a0f8ae658207f1f662367381c248eb7a8/activemodel/lib/active_model/validations.rb#L186
`set_callback`ãƒ¡ã‚½ãƒƒãƒ‰ã¯æ¬¡ã§å‘¼ã³å‡ºã•ã‚Œã‚‹ã€‚
```ruby
set_callback(:validate, ActiveModel::Validations::PresenceValidator.new, {:if=>:paid_with_card?, :attributes=>[:name], :class=>Order})
```


### ActiveSupport::Callbacks::ClassMethods#define_callbacksã®ä¸­èº«ã‚’èª­ã‚€
https://github.com/rails/rails/blob/66099147482ea431febf20936cec903f197d24be/activemodel/lib/active_model/validations.rb#L69

#### 1. define_callbacksãƒ¡ã‚½ãƒƒãƒ‰ã®å¼•æ•°ã‚’ç¢ºèªã™ã‚‹
https://github.com/rails/rails/blob/9d74450a0f8ae658207f1f662367381c248eb7a8/activesupport/lib/active_support/callbacks.rb#L937-L938

`names = [:validate, {:scope=>:name}]`ã¨ãªã‚‹ã®ã§ã€
```ruby
options = {:scope=>:name}
names = [:validate]
```

#### 2.
https://github.com/rails/rails/blob/9d74450a0f8ae658207f1f662367381c248eb7a8/activesupport/lib/active_support/callbacks.rb#L940-L945

`name = :validate`ã¨ãªã‚‹ã€‚
`self = Order`ã§ã€`descendants`ã¯`Order`ã‚ˆã‚Šä¸‹ä½ã«ã‚ã‚‹å…¨ã¦ã®ã‚¯ãƒ©ã‚¹ã‚’è¿”ã™ã®ã§ã€`self.descendants = []`ã¨ãªã‚‹ã€‚([descendants](https://railsguides.jp/active_support_core_extensions.html#descendants))

https://github.com/rails/rails/blob/9d74450a0f8ae658207f1f662367381c248eb7a8/activesupport/lib/active_support/callbacks.rb#L972-L978
https://github.com/rails/rails/blob/9d74450a0f8ae658207f1f662367381c248eb7a8/activesupport/lib/active_support/callbacks.rb#L70

`singleton_class.method_defined?(:__callbacks, false)`ã¯`false`ã«ãªã‚‹ã®ã§`self.__callbacks = {}`ã¨ãªã‚Šã€
```ruby
self.__callbacks[:validate] = CallbackChain.new(:validate, {:scope=>:name})
```

https://github.com/rails/rails/blob/9d74450a0f8ae658207f1f662367381c248eb7a8/activesupport/lib/active_support/callbacks.rb#L947-L965

ã¾ãŸã€`Order`ã‚¯ãƒ©ã‚¹ã«æ¬¡ã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒå®šç¾©ã•ã‚Œã‚‹ã€‚
```ruby
def _run_validate_callbacks(&block)
  run_callbacks :validate, &block
end

def self._validate_callbacks
  get_callbacks(:validate)
end

def self._validate_callbacks=(value)
  set_callbacks(:validate, value)
end

def _validate_callbacks
  __callbacks[:validate]
end
```

### ActiveSupport::Callbacks::ClassMethods#set_callbackã®ä¸­èº«ã‚’èª­ã‚€

#### 1. set_callbackãƒ¡ã‚½ãƒƒãƒ‰ã®å¼•æ•°ã‚’ç¢ºèªã™ã‚‹

https://github.com/rails/rails/blob/9d74450a0f8ae658207f1f662367381c248eb7a8/activesupport/lib/active_support/callbacks.rb#L776-L777

```ruby
name = :validate
filter_list = [ActiveModel::Validations::PresenceValidator.new, {:if=>:paid_with_card?, :attributes=>[:name], :class=>Order}]
```

https://github.com/rails/rails/blob/9d74450a0f8ae658207f1f662367381c248eb7a8/activesupport/lib/active_support/callbacks.rb#L716-L721
https://github.com/rails/rails/blob/9d74450a0f8ae658207f1f662367381c248eb7a8/activesupport/lib/active_support/callbacks.rb#L73
ã«ã‚ˆã‚Šã€

```ruby
type = :before
filters = [ActiveModel::Validations::PresenceValidator.new]
options = {:if=>:paid_with_card?, :attributes=>[:name], :class=>Order}
```

#### 2.


https://github.com/rails/rails/blob/9d74450a0f8ae658207f1f662367381c248eb7a8/activesupport/lib/active_support/callbacks.rb#L779-L782
`self_chain = CallbackChain.new(:validate, {:scope=>:name})`ã«ã‚ˆã‚Šã€
```ruby
mapped = [Callback.build(CallbackChain.new(:validate, {:scope=>:name}), ActiveModel::Validations::PresenceValidator.new, :before, {:if=>:paid_with_card?, :attributes=>[:name], :class=>Order})]
```

https://github.com/rails/rails/blob/9d74450a0f8ae658207f1f662367381c248eb7a8/activesupport/lib/active_support/callbacks.rb#L784-L787

https://github.com/rails/rails/blob/9d74450a0f8ae658207f1f662367381c248eb7a8/activesupport/lib/active_support/callbacks.rb#L725-L730
`self = Order`ãªã®ã§ã€`self.descendants.prepend(self) = Order`ã¨ãªã‚‹ã®ã§ã€
```ruby
chain = CallbackChain.new(:validate, {:scope=>:name})
```
`yield`ã«ã‚ˆã‚Šã€ãƒ–ãƒ­ãƒƒã‚¯æ§‹æ–‡ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã€‚
`options = {:if=>:paid_with_card?, :attributes=>[:name], :class=>Order}`ã«ã‚ˆã‚Šã€`options[:prepend] = nil`ã¨ãªã‚‹ã®ã§ã€`chain.append(*mapped)`ãŒå®Ÿè¡Œã•ã‚Œã€
```ruby
